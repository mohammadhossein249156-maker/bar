async function buildTable(symbolFilter=null){
  const tbody=document.querySelector("#crypto-table tbody");
  tbody.innerHTML=""; 
  setLoading(true);

  const symbolsToProcess = symbolFilter ? SYMBOLS.filter(s=>s.includes(symbolFilter)) : SYMBOLS;
  const selectedInterval = document.getElementById("interval").value;

  for(const symbol of symbolsToProcess){
    try{
      const kl = await fetchKlines(symbol, selectedInterval, 300);
      if(!kl || kl.length===0) continue;

      const closes = kl.map(k=>+k[4]);
      const highs = kl.map(k=>+k[2]);
      const lows = kl.map(k=>+k[3]);
      const last = closes.at(-1) || 0;

      const ema9v = ema(closes,9).at(-1) || 0;
      const ema20v = ema(closes,20).at(-1) || 0;
      const ema50v = ema(closes,50).at(-1) || 0;
      const ema100v = ema(closes,100).at(-1) || 0;
      const ema200v = ema(closes,200).at(-1) || 0;
      const rsiv = rsi(closes,14).at(-1) || 0;
      const {macdLine,signalLine} = macd(closes,12,26,9);
      const macdv = macdLine.at(-1) || 0;
      const sigv = signalLine.at(-1) || 0;
      const atrv = atr(highs,lows,closes,14).at(-1) || 0;

      // استراتژی‌ها
      const strategy = decideStrategy({last, ema20v, ema50v, ema200v, rsiv, macdv, sigv});
      const correction = correctionBadge({last, ema20v, ema50v, rsiv, macdv, sigv});

      // شرایط پوزیشن طولانی / کوتاه
      const longCond = last>ema20v && macdv>sigv && rsiv>50;
      const shortCond = last<ema20v && macdv<sigv && rsiv<50;
      const entry = longCond ? last.toFixed(4) : shortCond ? last.toFixed(4) : "-";
      const exitPlan = atrv ? (longCond ? `TP:${(last+1.5*atrv).toFixed(4)} | SL:${(last-1*atrv).toFixed(4)}` 
                                        : shortCond ? `TP:${(last-1.5*atrv).toFixed(4)} | SL:${(last+1*atrv).toFixed(4)}` 
                                        : "-") : "-";

      // حمایت و مقاومت
      const last20 = closes.slice(-20);
      const support = Math.min(...last20);
      const resistance = Math.max(...last20);
      const onSupport = withinPct(last,support,0.3)?"✅":"—";
      const onResistance = withinPct(last,resistance,0.3)?"✅":"—";

      // سایر سیگنال‌ها
      const breakout = last>resistance*1.002?"✅":"—";
      const prevRsi = rsi(closes,14).slice(-2)[0] || 0;
      const bounce = withinPct(last,support,0.3)&&rsiv>prevRsi?"✅":"—";
      const ema50Prev=ema(closes,50).slice(-2)[0]||0;
      const ema200Prev=ema(closes,200).slice(-2)[0]||0;
      const golden = (ema50Prev<ema200Prev && ema50v>ema200v)?"✅":"—";
      const rally = (last>ema9v && last>ema20v && rsiv>70 && macdv>sigv)?"✅":"—";

      // ردیف جدول
      const tr=document.createElement("tr");
      tr.innerHTML=`
<td class="nowrap">${symbol}</td>
<td class="nowrap">${selectedInterval}</td>
<td>${fmt(last,4)}</td>
<td>${fmt(rsiv,2)}</td>
<td>${fmt(ema9v,4)}</td>
<td>${fmt(ema20v,4)}</td>
<td>${fmt(ema50v,4)}</td>
<td>${fmt(ema100v,4)}</td>
<td>${fmt(ema200v,4)}</td>
<td class="${macdv>=sigv?"positive":"negative"}">${fmt(macdv,6)}</td>
<td class="${macdv>=sigv?"positive":"negative"}">${fmt(sigv,6)}</td>
<td>${longCond?"L":""}</td>
<td>${shortCond?"S":""}</td>
<td>-</td>
<td>${longCond?'<span class="badge good">✅</span>':'<span class="badge neutral">—</span>'}</td>
<td>${shortCond?'<span class="badge bad">⚠</span>':'<span class="badge neutral">—</span>'}</td>
<td>${entry}</td>
<td>${exitPlan}</td>
<td>${fmt(support,4)}</td>
<td>${fmt(resistance,4)}</td>
<td>${onSupport}</td>
<td>${onResistance}</td>
<td>${breakout}</td>
<td>${bounce}</td>
<td>${golden}</td>
<td>${rally}</td>
<td>${strategy}</td>
<td>${correction}</td>`;
      tbody.appendChild(tr);

    }catch(err){
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="28" class="negative">خطا برای ${symbol}: ${err.message}</td>`;
      tbody.appendChild(tr);
    }
  }
  document.getElementById("lastUpdate").textContent="آخرین بروزرسانی: "+new Date().toLocaleString();
  setLoading(false);
}
