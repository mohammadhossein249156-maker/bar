<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>📊 Crypto Dashboard – Correction Alert</title>
<style>
body{font-family:tahoma,Arial,sans-serif;direction:rtl;background:#f5f7fb;margin:0}
header{background:#1e88e5;color:#fff;padding:14px 10px;text-align:center}
.wrap{max-width:1500px;margin:16px auto;padding:0 12px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
input,select,button{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px;font-family:inherit}
button{background:#1e88e5;color:#fff;cursor:pointer}
button:disabled{background:#90caf9;cursor:not-allowed}
.note{font-size:12px;color:#546e7a;margin-top:6px}
.table-wrap{overflow:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
table{border-collapse:collapse;width:100%}
th,td{border-bottom:1px solid #eee;padding:8px 10px;text-align:center;white-space:nowrap;font-size:13px}
th{background:#e3f2fd;color:#0d47a1;position:sticky;top:0;z-index:1}
tr:hover{background:#fafcff}
.positive{color:#2e7d32;font-weight:600}
.negative{color:#c62828;font-weight:600}
.badge{padding:2px 6px;border-radius:8px;font-weight:600}
.good{background:#e8f5e9;color:#2e7d32}
.bad{background:#ffebee;color:#c62828}
.neutral{background:#eceff1;color:#37474f}
.nowrap{white-space:nowrap}
.ltr{direction:ltr}
.correction-ok{background:#e8f5e9;color:#2e7d32;font-weight:600;border-radius:6px;padding:2px 6px}
.correction-warning{background:#ffe0b2;color:#ef6c00;font-weight:600;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
<h2>📊 Crypto Dashboard – Correction Alert</h2>
<div style="font-size:12px;opacity:.9">منبع داده: Binance (OHLCV) | اندیکاتورها در مرورگر محاسبه می‌شوند</div>
</header>

<div class="wrap">
<div class="controls">
<label>تایم‌فریم:</label>
<select id="interval">
<option value="5m">5m</option>
<option value="15m" selected>15m</option>
<option value="1h">1h</option>
<option value="4h">4h</option>
<option value="1d">1d</option>
</select>
<button id="refreshBtn">بروزرسانی</button>
<input type="text" id="searchBox" class="ltr" placeholder="Search Symbol..." />
<button id="saveBtn">📥 ذخیره در نوت‌پد</button>
<span id="lastUpdate" class="note"></span>
</div>

<div class="table-wrap">
<table id="crypto-table">
<thead>
<tr>
<th>Symbol</th><th>Interval</th><th>Price</th><th>RSI(14)</th><th>EMA9</th><th>EMA20</th><th>EMA50</th><th>EMA100</th><th>EMA200</th>
<th>MACD</th><th>Signal</th><th>L</th><th>S</th><th>PP</th><th>Long</th><th>Short</th>
<th>Entry</th><th>Exit (TP/SL)</th><th>Support</th><th>Resistance</th><th>تثبیت روی حمایت؟</th>
<th>تثبیت روی مقاومت؟</th><th>Breakout</th><th>Bounce</th><th>Golden Cross</th><th>Rally</th>
<th>استراتژی</th><th>در حال اصلاح؟</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="note">نکته: این ابزار صرفاً آموزشی است و سیگنال قطعی معامله محسوب نمی‌شود.</div>
</div>

<script>
const SYMBOLS = ["BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","SOLUSDT","ADAUSDT","DOGEUSDT","TRXUSDT","MATICUSDT","DOTUSDT","LTCUSDT","AVAXUSDT","LINKUSDT","ATOMUSDT","ETCUSDT","XLMUSDT","FILUSDT","APTUSDT","NEARUSDT","ARBUSDT"];
const INTERVALS = ["5m","15m","1h","4h","1d"];
const PROXY = url=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
const fmt=(n,d=2)=>(n==null||isNaN(n)?"-":Number(n).toLocaleString(undefined,{maximumFractionDigits:d}));
const withinPct=(price,level,pct=0.3)=>{if(!price||!level)return false;return Math.abs((price-level)/level)*100<=pct;}

function ema(values,period){if(!values||values.length===0)return[];const k=2/(period+1);const out=[];let prev=values[0];out.push(prev);for(let i=1;i<values.length;i++){const v=values[i]*k+prev*(1-k);out.push(v);prev=v;}return out;}
function rsi(values,period=14){if(!values||values.length<period+1)return[];let gains=0,losses=0;for(let i=1;i<=period;i++){const diff=values[i]-values[i-1];diff>=0?gains+=diff:losses-=diff;}let avgGain=gains/period,avgLoss=losses/period;const out=new Array(period).fill(null);for(let i=period+1;i<values.length;i++){const diff=values[i]-values[i-1];const gain=diff>0?diff:0;const loss=diff<0?-diff:0;avgGain=(avgGain*(period-1)+gain)/period;avgLoss=(avgLoss*(period-1)+loss)/period;const rs=avgLoss===0?1000:avgGain/avgLoss;out.push(100-(100/(1+rs)));}return out;}
function macd(values,fast=12,slow=26,signalPeriod=9){const ef=ema(values,fast);const es=ema(values,slow);const macdLine=ef.map((v,i)=>(es[i]==null?null:(v-es[i])));const start=slow;const macdValid=macdLine.slice(start).filter(v=>v!=null);const signalPart=ema(macdValid,signalPeriod);const signalLine=new Array(start).fill(null).concat(signalPart);return {macdLine,signalLine};}
function atr(highs,lows,closes,period=14){const trs=[];for(let i=0;i<highs.length;i++){if(i===0){trs.push(highs[i]-lows[i]);continue;}const hl=highs[i]-lows[i];const hc=Math.abs(highs[i]-closes[i-1]);const lc=Math.abs(lows[i]-closes[i-1]);trs.push(Math.max(hl,hc,lc));}if(trs.length<period)return[];let rma=trs.slice(0,period).reduce((a,b)=>a+b,0)/period;const out=new Array(period-1).fill(null);out.push(rma);for(let i=period;i<trs.length;i++){rma=(rma*(period-1)+trs[i])/period;out.push(rma);}return out;}

async function fetchKlines(symbol,interval="15m",limit=300){
  const res=await fetch(PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`));
  if(!res.ok)throw new Error(`HTTP ${res.status}`);
  const data=await res.json();
  if(!Array.isArray(data))throw new Error("Bad payload");
  return data;
}

async function fetchWeeklyKlines(symbol, limit=100){
  const res = await fetch(PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1w&limit=${limit}`));
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error("Bad payload");
  return data;
}

async function fetchDailyPivot(symbol){
  const res=await fetch(PROXY(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=3`));
  if(!res.ok)return null;
  const data=await res.json();
  if(!Array.isArray(data)||data.length<2)return null;
  const prev=data[data.length-2],H=+prev[2],L=+prev[3],C=+prev[4];
  return (H+L+C)/3;
}

function setLoading(state){document.getElementById('refreshBtn').disabled=state;document.getElementById('refreshBtn').textContent=state?'در حال بروزرسانی…':'بروزرسانی';}

// 🔹 تصمیم‌گیری استراتژی تک تایم‌فریم
function decideStrategy({last, ema20v, ema50v, ema200v, rsiv, macdv, sigv}) {
    if(last == null || ema20v == null || ema50v == null || ema200v == null || rsiv == null || macdv == null || sigv == null)
        return "-";
    if(last > ema20v && last > ema50v && ema50v > ema200v && macdv > sigv && rsiv > 50) return "هولد";
    if(last < ema20v && last < ema50v && ema50v < ema200v && macdv < sigv && rsiv < 50) return "فروش";
    return "نوسان‌گیری";
}

// 🔹 ترکیب دو تایم‌فریم
function combineStrategies(daily, weekly){
    if(daily==="هولد" && weekly==="هولد") return "هولد";
    if(daily==="فروش" && weekly==="فروش") return "فروش";
    return "نوسان‌گیری";
}

// 🔹 تشخیص اصلاح کوتاه‌مدت با رنگ
function correctionBadge({last, ema20v, ema50v, rsiv, macdv, sigv}){
    if(last == null || ema20v == null || ema50v == null || rsiv == null || macdv == null || sigv == null)
        return '<span class="correction-ok">—</span>';
    const isCorrecting = (last < ema20v && last < ema50v && rsiv < 50 && macdv < sigv);
    return isCorrecting ? '<span class="correction-warning" title="اصلاح کوتاه‌مدت">⚠️</span>'
                        : '<span class="correction-ok" title="روند سالم">✅</span>';
}

// 🔹 buildTable مشابه نسخه قبلی با اضافه کردن ستون correctionBadge
// … (کد مشابه نسخه قبلی با جایگزینی const correction = correctionBadge(...))

// 🔽 ذخیره جدول در فایل txt
function saveTableToTxt() {
  const table = document.getElementById("crypto-table");
  let txt = "";

  const headers = Array.from(table.querySelectorAll("thead th"))
    .map(th => th.textContent.trim())
    .join("\t");
  txt += headers + "\n";

  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll("td"))
      .map(td => td.textContent.trim())
      .join("\t");
    txt += cells + "\n";
  });

  const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "crypto_data.txt";
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('refreshBtn').addEventListener('click',()=>{
  const symbolSearch=document.getElementById('searchBox').value.trim().toUpperCase();
  if(symbolSearch){
    buildTable(symbolSearch,true);
