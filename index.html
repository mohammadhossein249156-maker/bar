async function buildTable(symbolFilter = null) {
  const tbody = document.querySelector("#crypto-table tbody");
  tbody.innerHTML = "";
  setLoading(true);

  // تعیین سمبل‌ها و تایم‌فریم‌ها
  const symbolsToProcess = symbolFilter ? SYMBOLS.filter(s => s.includes(symbolFilter)) : SYMBOLS;
  const intervalsToProcess = symbolFilter ? INTERVALS : [document.getElementById("interval").value];

  try {
    for (const symbol of symbolsToProcess) {
      for (const interval of intervalsToProcess) {
        try {
          const kl = await fetchKlines(symbol, interval, 300);
          if (!kl || kl.length === 0) continue;

          const closes = kl.map(k => +k[4]);
          const highs = kl.map(k => +k[2]);
          const lows = kl.map(k => +k[3]);
          const last = closes.at(-1) || 0;

          const ema9v = ema(closes, 9).at(-1) || 0;
          const ema20v = ema(closes, 20).at(-1) || 0;
          const ema50v = ema(closes, 50).at(-1) || 0;
          const ema100v = ema(closes, 100).at(-1) || 0;
          const ema200v = ema(closes, 200).at(-1) || 0;

          const rsiv = rsi(closes, 14).at(-1) || 0;
          const { macdLine, signalLine } = macd(closes, 12, 26, 9);
          const macdv = macdLine.at(-1) || 0;
          const sigv = signalLine.at(-1) || 0;

          const atrv = atr(highs, lows, closes, 14).at(-1) || 0;

          // تصمیم استراتژی
          const strategy = decideStrategy({ last, ema20v, ema50v, ema200v, rsiv, macdv, sigv });
          const correction = correctionBadge({ last, ema20v, ema50v, rsiv, macdv, sigv });

          // شرایط L / S
          const longCond = last > ema20v && macdv > sigv && rsiv > 50;
          const shortCond = last < ema20v && macdv < sigv && rsiv < 50;

          // سطوح حمایت / مقاومت
          const last20 = closes.slice(-20);
          const support = Math.min(...last20);
          const resistance = Math.max(...last20);
          const onSupport = withinPct(last, support, 0.3) ? "✅" : "—";
          const onResistance = withinPct(last, resistance, 0.3) ? "✅" : "—";
          const breakout = last > resistance * 1.002 ? "✅" : "—";

          const prevRsi = rsi(closes, 14).slice(-2)[0] || 0;
          const bounce = withinPct(last, support, 0.3) && rsiv > prevRsi ? "✅" : "—";

          const ema50Prev = ema(closes, 50).slice(-2)[0] || 0;
          const ema200Prev = ema(closes, 200).slice(-2)[0] || 0;
          const golden = ema50Prev < ema200Prev && ema50v > ema200v ? "✅" : "—";
          const rally = last > ema9v && last > ema20v && rsiv > 70 && macdv > sigv ? "✅" : "—";

          const tr = document.createElement("tr");
          tr.innerHTML = `
<td class="nowrap">${symbol}</td>
<td class="nowrap">${interval}</td>
<td>${fmt(last, 4)}</td>
<td>${fmt(rsiv, 2)}</td>
<td>${fmt(ema9v, 4)}</td>
<td>${fmt(ema20v, 4)}</td>
<td>${fmt(ema50v, 4)}</td>
<td>${fmt(ema100v, 4)}</td>
<td>${fmt(ema200v, 4)}</td>
<td>${fmt(macdv, 6)}</td>
<td>${fmt(sigv, 6)}</td>
<td>${longCond ? "L" : ""}</td>
<td>${shortCond ? "S" : ""}</td>
<td>-</td>
<td>${longCond ? "✅" : "—"}</td>
<td>${shortCond ? "⚠" : "—"}</td>
<td>-</td>
<td>-</td>
<td>${fmt(support, 4)}</td>
<td>${fmt(resistance, 4)}</td>
<td>${onSupport}</td>
<td>${onResistance}</td>
<td>${breakout}</td>
<td>${bounce}</td>
<td>${golden}</td>
<td>${rally}</td>
<td>${strategy}</td>
<td>${correction}</td>
`;
          tbody.appendChild(tr);
        } catch (err) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="27" class="negative">خطا برای ${symbol} (${interval}): ${err.message}</td>`;
          tbody.appendChild(tr);
        }
      }
    }
  } finally {
    document.getElementById("lastUpdate").textContent = "آخرین بروزرسانی: " + new Date().toLocaleString();
    setLoading(false);
  }
}
