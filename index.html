<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0d47a1;
      color: white;
      padding: 10px;
      text-align: center;
    }
    .controls {
      margin: 10px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #1976d2;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* ✅ رنگ‌بندی واضح‌تر سطرها */
    tr:nth-child(odd) { background-color: #f1f5f9; }
    tr:nth-child(even) { background-color: #e0f2fe; }
    tr:hover { background-color: #cbd5e1; }

    /* ✅ اسکرول افقی نرم */
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ✅ ستون اول ثابت */
    td:first-child, th:first-child {
      position: sticky;
      left: 0;
      background: #fdfdfd;
      z-index: 2;
      font-weight: bold;
    }

    /* ✅ کوچک‌سازی در موبایل */
    @media (max-width: 768px) {
      table { font-size: 11px; }
      th, td { padding: 3px 4px; }
    }
    @media (max-width: 480px) {
      table { font-size: 9px; }
      th, td { padding: 2px 3px; }
    }
  </style>
</head>
<body>
  <header>
    <h2>Crypto Dashboard</h2>
  </header>
  <div class="controls">
    <label for="interval">Interval:</label>
    <select id="interval">
      <option value="5m">5m</option>
      <option value="15m">15m</option>
      <option value="1h">1h</option>
      <option value="4h">4h</option>
      <option value="1d">1d</option>
    </select>
    <input type="text" id="search" placeholder="Search symbol...">
    <button onclick="refreshData()">Refresh</button>
    <button onclick="downloadTXT()">Download TXT</button>
  </div>
  <div class="table-wrap">
    <table id="cryptoTable">
      <thead>
        <tr>
          <th>Symbol</th><th>Interval</th><th>Price</th><th>RSI</th><th>EMA9</th><th>EMA20</th>
          <th>EMA50</th><th>EMA100</th><th>EMA200</th><th>MACD</th><th>Signal</th>
          <th>Support</th><th>Resistance</th><th>OnSupport</th><th>OnResistance</th>
          <th>Breakout</th><th>Bounce</th><th>Golden</th><th>Rally</th><th>Strategy</th><th>Correction</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    const symbols = ["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","ADAUSDT","DOGEUSDT","AVAXUSDT","TRXUSDT","MATICUSDT"];
    const tableBody = document.querySelector("#cryptoTable tbody");

    function fmt(num, dec=2){ return Number(num).toFixed(dec); }

    async function fetchKlines(symbol, interval, limit=200){
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
      const res = await fetch(url);
      return await res.json();
    }

    function EMA(data, period){
      let k = 2/(period+1);
      let emaArray = [];
      emaArray[0] = data[0];
      for(let i=1; i<data.length; i++){
        emaArray[i] = data[i]*k + emaArray[i-1]*(1-k);
      }
      return emaArray;
    }

    function RSI(closes, period=14){
      let gains=0, losses=0;
      for(let i=1;i<=period;i++){
        let diff=closes[i]-closes[i-1];
        if(diff>=0) gains+=diff; else losses-=diff;
      }
      let avgGain=gains/period, avgLoss=losses/period;
      let rs=avgGain/avgLoss; let rsi=[100-100/(1+rs)];
      for(let i=period+1;i<closes.length;i++){
        let diff=closes[i]-closes[i-1];
        if(diff>=0){ avgGain=(avgGain*(period-1)+diff)/period; avgLoss=(avgLoss*(period-1))/period; }
        else { avgGain=(avgGain*(period-1))/period; avgLoss=(avgLoss*(period-1)-diff)/period; }
        rs=avgGain/avgLoss; rsi.push(100-100/(1+rs));
      }
      return rsi;
    }

    function MACD(closes, fast=12, slow=26, signal=9){
      let emaFast=EMA(closes, fast), emaSlow=EMA(closes, slow);
      let macd=emaFast.map((v,i)=>v-emaSlow[i]);
      let signalLine=EMA(macd.slice(slow), signal);
      let hist=macd.slice(slow+signal-1).map((v,i)=>v-signalLine[i]);
      return {macd, signal:signalLine, hist};
    }

    async function refreshData(){
      tableBody.innerHTML = "";
      let interval = document.getElementById("interval").value;
      let searchVal = document.getElementById("search").value.toUpperCase();
      for(let symbol of symbols){
        if(searchVal && !symbol.includes(searchVal)) continue;
        try{
          let klines = await fetchKlines(symbol, interval);
          let closes = klines.map(k=>parseFloat(k[4]));
          let last=closes[closes.length-1];
          let ema9=EMA(closes,9), ema20=EMA(closes,20), ema50=EMA(closes,50), ema100=EMA(closes,100), ema200=EMA(closes,200);
          let rsis=RSI(closes,14), rsiv=rsis[rsis.length-1];
          let macdObj=MACD(closes); let macdv=macdObj.macd.at(-1), sigv=macdObj.signal.at(-1);
          let recent=closes.slice(-20);
          let support=Math.min(...recent), resistance=Math.max(...recent);
          let onSupport=last<=support*1.01?"Yes":"";
          let onResistance=last>=resistance*0.99?"Yes":"";
          let breakout=last>resistance?"Yes":"";
          let bounce=(onSupport&&rsiv>40)?"Yes":"";
          let golden=(ema50.at(-1)>ema200.at(-1)&&ema50.at(-2)<=ema200.at(-2))?"Yes":"";
          let rally=(rsiv>60 && last>ema50.at(-1)&&macdv>sigv)?"Yes":"";
          let strategy= rally?"Hold": breakout?"Buy": onResistance?"Sell": onSupport?"Accumulate":"";
          let correction= (rsiv>70)?"Overbought":(rsiv<30)?"Oversold":"OK";

          const tr=document.createElement("tr");
          const cells=[symbol, interval, fmt(last,4), fmt(rsiv,2), fmt(ema9.at(-1),4), fmt(ema20.at(-1),4),
          fmt(ema50.at(-1),4), fmt(ema100.at(-1),4), fmt(ema200.at(-1),4), fmt(macdv,6), fmt(sigv,6),
          fmt(support,4), fmt(resistance,4), onSupport, onResistance, breakout, bounce, golden, rally, strategy, correction];

          cells.forEach(val=>{
            const td=document.createElement("td");
            td.textContent=val;
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        }catch(e){console.log("Error",symbol,e);}
      }
    }

    function downloadTXT(){
      let rows=[...document.querySelectorAll("#cryptoTable tr")].map(r=>[...r.children].map(td=>td.innerText).join("\t"));
      let blob=new Blob([rows.join("\n")],{type:"text/plain"});
      let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="crypto_dashboard.txt"; a.click();
    }

    refreshData();
  </script>
</body>
</html>
